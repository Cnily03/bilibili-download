/*! dlbili.auto.min.js v0.1.0 | MIT License | github.com/cnily03/bili-download */
dlbiliAuto=async(e,t=!1)=>{const r=t,n=e,o=32,a="http://localhost:6800/jsonrpc",l="POST",i="https://api.bilibili.com/x/web-interface/view?",c="https://api.bilibili.com/x/player/playurl?";var s,p,d,h,u,w;const g=window.bvid,b=window.p+1,f=window.btoa,m=window.j;window.rpcUrl=window.rpcUrl||a,window.rpcMethod=window.rpcMethod||l,await new Promise(e=>{$.ajax({url:i+"bvid="+g,type:"GET",dataType:"json",success:t=>{e(t.data)}})}).then(e=>{s=e.pages,p=e.title,h=s.length.toString().length});const S=e=>{let t=e.replace(/\?.*/,"").split(".");return"."+t[t.length-1]},y=e=>{let t="";for(let r=0;r<e.length;r++){let n=e[r];t+=/[^\x00-\xFF]/.test(n)?"\\u"+n.charCodeAt().toString(16).padStart(4,"0"):n}return t},P=async(e,t,r,n)=>{for(let l=0;l<r.length;l++){var o=S(r[l]),a={id:g+"-"+(new Date).getTime(),method:"aria2.addUri",params:[[r[l]],{out:n+(r.length-1?" Part "+l.toString().padStart(r.length.toString().length,"0"):"")+o,referer:window.location.href}]};["POST","GET"].indexOf(t)&&(a.params=f(y(JSON.stringify(a.params)))),await new Promise(r=>{$.ajax({url:e,data:"GET"==t?a:JSON.stringify(a),type:t,contentType:"application/json-rpc",dataType:"json",success:e=>{e.result?u++:w++,r()},error:()=>{w++,r()}})})}};await m("https://cdn.jsdelivr.net/gh/Stuk/jszip@3.7.1/dist/jszip.min.js");const T=async(e=1,t=!1)=>{if(!t&&r)return void v([e]);var o=[];if(moreThanOneP=!!(s.length-1),await new Promise(t=>{$.ajax({url:c+"cid="+s[e-1].cid+"&"+n+"&bvid="+g,type:"GET",dataType:"json",success:e=>{t(e.data)}})}).then(e=>{d=e.quality>=120,e.durl.forEach(e=>{o.push(e.url)})}),!t&&d)return void v([e]);let a=(e=>e.replace(/[\u002a\u002e\u003f\u0022\u003c\u003e\u007c\u002f\u005c]/g,"_"))(moreThanOneP?s[e-1].part:p),l=g+(moreThanOneP?"_p"+e.toString().padStart(h,"0"):"")+" "+a;if(t)return[o,l];(async(e,t,r)=>{const n=S(e[0]),o=window.URL||window.webkitURL||window;var a=document.createElementNS("http://www.w3.org/1999/xhtml","a");const l=e=>new Promise(t=>{let r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="blob",r.onload=(()=>{200===r.status&&t(r.response)}),r.send()});var i=await(async e=>{var t=[];for(let o=0;o<e.length;o++)try{let a=await l(e[o]);t.push({name:r+" "+o.toString().padStart(e.length.toString().length,"0")+n,blob:new Blob([a])})}catch(e){}return t})(e);if(i.length-1){var c=new JSZip;i.forEach(e=>{e&&c.file(e.name,e.blob)}),c.generateAsync({type:"blob"}).then(e=>{a.href=o.createObjectURL(e),a.download=t,a.click(),o.revokeObjectURL(a.href)})}else i.length?(a.href=o.createObjectURL(i[0].blob),a.download=t+n,a.click(),o.revokeObjectURL(a.href)):alert("下载失败！")})(o,l,a),alert("已发送下载！请等待后台下载完成。")},v=async e=>{var t,r;let n=0;if(null!=(t=prompt("请输入RPC地址\n（默认："+rpcUrl+"）"))){t=t||rpcUrl,n=0;do{null!=(r=prompt((n?"输入错误！只能输入 POST 或 GET\n\n":"")+"请输入RPC请求方法 ( POST | GET )\n（默认："+rpcMethod+"）"))?["POST","GET",""].includes(r.toUpperCase())?(r=r||rpcMethod,n=0):n=1:n=0}while(n);if(null!=r){u=w=0;for(let t=0;t<e.length;t++){let r=await T(e[t],!0);await P(rpcUrl,rpcMethod,r[0],r[1])}u?(alert("已尝试发送\n- 成功 "+u+" | 失败 "+w+"\n请在你的RPC客户端查看下载。"),rpcUrl=t,rpcMethod=r):alert("发送失败，你可以尝试这样做：\n- 检查你的RPC客户端是否开启\n- 检查RPC地址是否为 "+t+"\n- 检查RPC请求方法是否为 "+r)}}},j=(e="")=>{let t=prompt(e+"请在下框中输入你要下载的分集（默认为当前P）\n（如输入「1,2,7-9,15」）\n单次下载超过"+o+"集可能会有账号风险\n- 分集列表已输出至控制台");if(null!==t)if(""==t)T(b);else{let e=[],r=!0;const n=t=>{r&&t&&t<=s.length?!e.includes(t)&&e.push(t):r=!1};t.split(",").forEach(e=>{e.includes("-")?(()=>{let t=e.split("-");var r=parseInt(t[0])||0,o=parseInt(t[1])||0;let a=r;r=r>o?o:r,o=o>a?o:a;for(let e=r;e<=o;e++)n(e)})():n(parseInt(e))}),e.length&&r?e.length<=o?(e.sort((e,t)=>e-t),e.length-1?v(e):T(e[0])):j("为了您的账号安全，单次下载请不要超过"+o+"集。\n\n"):j("输入格式错误或者分P不存在，请重新输入！\n\n")}};s.length-1?((()=>{const e="color:#FFF;background-color:#0055BA;border-radius:10%;font-size:larger",t="color:#FFF;background-color:green;border-radius:20%;",r="color:#FFF;background-color:#0055BA;border-radius:20%;",n="margin-left:10px;",o="color:#FFF;background-color:#C63;border-radius:20%;margin-left:10px;";console.clear(),console.info("%c 分P列表 ",e),s.forEach(e=>{console.info("%c "+e.page.toString().padStart(h,"0")+" %c "+e.part+" ",e.page==b?r:t,e.page==b?o:n)})})(),j()):T()};window.dlbAuto=!0;